---
title: "EV Power - Lab 4 Project Report"
subtitle: "EV Registrations and Energy Prices Across U.S. States"
format: typst
---


```{r}
#| echo: false
#| message: false
#| warning: false
## **Part 0: libraries**
renew_use_2021 <- read.csv("data/renew-use-2021.csv")
renew_use_2022 <- read.csv("data/renew-use-2022.csv")
renew_use_2023 <- read.csv("data/renew-use-2023.csv")
total_use_2021 <- read.csv("data/total-use-2021.csv")
total_use_2022 <- read.csv("data/total-use-2022.csv")
total_use_2023 <- read.csv("data/total-use-2023.csv")

avg_price <- read.csv('data/av-energy-price-2021-2023.csv', skip=2)    
ev_reg <- read.csv("data/ev-registrations-by-state-2023.csv", skip=2, stringsAsFactors = FALSE)
suppressPackageStartupMessages({
library(dplyr)
library(tidyverse)
library(stringr)
library(maps)
library(ggplot2)
})


## **Part 1:** **Defining Research Question**

#Chosen Question: Average energy price vs. EV registrations. Do lower energy prices support higher EV registration?

## **Part 2: Data Preparation and Cleaning**

colnames(avg_price) <- "string"
avg_price_clean <- avg_price|>
    mutate(                                           #Separate into columns
        state = str_extract(string, "^[A-Z]{2}"),
        price_2021 = str_extract(str_extract(string, "^[A-Z]{2},[^,]*,"), "[^,]*,$"),
        price_2022 = str_extract(str_extract(string, ",[^,]*,[^,]*$"), "^,[^,]*"),
        price_2023 = str_extract(string, ",[^,]*$") 
    )|>
    select(-1)|>
    mutate(         #clean columns
        price_2021 = as.numeric(str_extract(price_2021, "[0-9]*\\.[0-9]{2}")),
        price_2022 = as.numeric(str_extract(price_2022, "[0-9]*\\.[0-9]{2}")),
        price_2023 = as.numeric(str_extract(price_2023, "[0-9]*\\.[0-9]{2}"))
    )
 
ev_reg_clean <- ev_reg|>
    mutate(
        state = case_when(
            STATE == "District of Columbia" ~ "DC",
            STATE == "Total" ~ "Total",
            TRUE ~ state.abb[match(STATE, state.name)]),
        EV_count = as.numeric(str_extract(Count.EVs, "[0-9]+"))
    )|>
    select(3:4)
```
## Overview
This report investigates the relationship between the average cost of energy and the number of electric vehicles (ev) registered in 2023 across different states. The main research question is: *Do states with lower energy prices support higher EV adoption?*

## Data and Methods
We use datasets containing the average energy price per state from 2021 to 2023 and EV registrations in 2023. These were read from csv files and edited using dplyr and stringr to normalize and merge. The table below shows the top and bottom five states for changes in average energy price between 2021 and 2023. For each state, we include the 2021 and 2023 prices, the calculated price change, the change direction (increase or decrease), and the EV count. This lets us examine which states experienced the biggest and smallest shifts in energy costs and sets the stage for comparing these changes to EV registration counts in the map visualization. By comparing price over time, we can better interpret patterns in EV adoption relative to energy price trends. Unfortunately the data on EV registration is not available but it would be interesting to see how EV registration has changed with price change.

```{r}
#| echo: false
#| message: false
#| warning: false
## **Part 3: Joining / Pivoting Datasets for Analysis**


state_prices_registrations <- left_join(avg_price_clean, ev_reg_clean, by = "state")|>
    mutate(
        price_avg = price_2021 + price_2022 + price_2023,
        price_change = price_2023 - price_2021,
        price_direction = ifelse(price_change > 0, "Increased", "Decreased")
    )
```
```{r}
#| echo: TRUE
state_prices_registrations |>
  arrange(desc(price_change)) |>
  select(state, price_2021, price_2023, price_change, price_direction, EV_count) |>
  slice(1:5, 48:52)
```
## Visualization
```{r}
#| echo: false
#| message: false
#| warning: false
## **Part 4: Mapping Visualization**


state_prices_map <- state_prices_registrations |>
  mutate(region = tolower(state.name[match(state, state.abb)]))
us_states <- map_data("state")
map_data_joined <- us_states |>
  left_join(state_prices_map, by = "region")
ggplot() +
  geom_polygon(
    data = map_data_joined,
    aes(long, lat, group = group, fill = price_change),
    color = "white") +
  geom_point(
    data = map_data_joined |>
      group_by(region) |>
      summarize(
        long = mean(range(long)), 
        lat = mean(range(lat)),
        EV_count = mean(EV_count, na.rm = TRUE)),
    aes(long, lat, size = EV_count),
    color = "black", alpha = 0.6) +
  scale_fill_gradient2(
    low = "blue", mid = "white", high = "red", midpoint = 0,
    name = "Energy Price Change") +
  scale_size_continuous(
    range = c(1, 10),
    name = "EV Registrations") +
  coord_fixed(1.3) +
  theme_minimal() +
  labs(
    title = "EV Registrations vs Change in Energy Price (2021â€“2023)",
    subtitle = "Circle size shows EV registration count; color shows price change") +
  theme(
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank()
  )
```

## Analysis
The initial summary table reveals a couple interesting features. There was only one state in which energy prices did not increase from 2021 to 2023, Louisianna. Additionally, there was a slight trend in which states with smaller increases (Texas, Iowa, Wyoming) or the one state with a decrease tended to have lower EV counts than the states with the highest price increases (Hawaii, Nevada, Maine and California). This is not by any means definitive as there are states with small increases that have high EV counts, however it suggests that the opposite of our hypothesis is true: Higher energy prices seem to support higher EV counts. The outliers indicate that while energy price is likely a factor in EV registration, other regional or policy factors likely highly contribute to EV rates.

The map solidifies the trend seen when examining the extremes of price changes. The states with higher energy price changes tended to have more EV registrations than those with lower changes. The map also reveals a spatial trend, with the east and west coasts having both higher energy price changes and EV registrations than the midwest. This further supports the theory that increases in energy prices can be used to predict EV registrations but that regional and other policy factors are also highly influential in both.

Overall, the combination of the map and the data table helps answer the research question by showing that there is a general trend linking higher energy prices to higher EV registrations, though the relationship is not strictly linear. Further analysis, such as a scatter plot or correlation analysis, could quantify this relationship more precisely.