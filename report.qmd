---
title: "EV Power - Lab 4 Project Report"
subtitle: "EV Registrations and Energy Prices Across U.S. States"
format: typst
---


```{r}
#| echo: false
#| message: false
#| warning: false
## **Part 0: libraries**
renew_use_2021 <- read.csv("data/renew-use-2021.csv")
renew_use_2022 <- read.csv("data/renew-use-2022.csv")
renew_use_2023 <- read.csv("data/renew-use-2023.csv")
total_use_2021 <- read.csv("data/total-use-2021.csv")
total_use_2022 <- read.csv("data/total-use-2022.csv")
total_use_2023 <- read.csv("data/total-use-2023.csv")

avg_price <- read.csv('data/av-energy-price-2021-2023.csv', skip=2)    
ev_reg <- read.csv("data/ev-registrations-by-state-2023.csv", skip=2, stringsAsFactors = FALSE)
suppressPackageStartupMessages({
library(dplyr)
library(tidyverse)
library(stringr)
library(maps)
library(ggplot2)
})


## **Part 1:** **Defining Research Question**

#Chosen Question: Average energy price vs. EV registrations. Do lower energy prices support higher EV registration?

## **Part 2: Data Preparation and Cleaning**

colnames(avg_price) <- "string"
avg_price_clean <- avg_price|>
    mutate(                                           #Separate into columns
        state = str_extract(string, "^[A-Z]{2}"),
        price_2021 = str_extract(str_extract(string, "^[A-Z]{2},[^,]*,"), "[^,]*,$"),
        price_2022 = str_extract(str_extract(string, ",[^,]*,[^,]*$"), "^,[^,]*"),
        price_2023 = str_extract(string, ",[^,]*$") 
    )|>
    select(-1)|>
    mutate(         #clean columns
        price_2021 = as.numeric(str_extract(price_2021, "[0-9]*\\.[0-9]{2}")),
        price_2022 = as.numeric(str_extract(price_2022, "[0-9]*\\.[0-9]{2}")),
        price_2023 = as.numeric(str_extract(price_2023, "[0-9]*\\.[0-9]{2}"))
    )
 
ev_reg_clean <- ev_reg|>
    mutate(
        state = case_when(
            STATE == "District of Columbia" ~ "DC",
            STATE == "Total" ~ "Total",
            TRUE ~ state.abb[match(STATE, state.name)]),
        EV_count = as.numeric(str_extract(Count.EVs, "[0-9]+"))
    )|>
    select(3:4)
```
## Overview
This report investigates the relationship between the average cost of energy across different states and the number of electric vehicles (ev) registered in 2023. The main research question is: *Do states with lower energy prices support higher EV adoption?*

## Data and Methods
We use datasets containing the average energy price per state from 2021 to 2023 and EV registrations in 2023. These were read from csv files and edited using dplyr and stringr to normalize. The table below shows the top five states with the largest changes in average energy price between 2021 and 2023. For each state, we include the 2021 and 2023 prices, the calculated price change, and the price direction (increase or decrease). This summary allows us to quickly identify which states experienced the biggest shifts in energy costs and sets the stage for comparing these changes to EV registration counts in the map visualization. By examining the extremes, we can better interpret patterns in EV adoption relative to energy price trends.

```{r}
#| echo: false
#| message: false
#| warning: false
## **Part 3: Joining / Pivoting Datasets for Analysis**


state_prices_registrations <- left_join(avg_price_clean, ev_reg_clean, by = "state")|>
    mutate(
        price_avg = price_2021 + price_2022 + price_2023,
        price_change = price_2023 - price_2021,
        price_direction = ifelse(price_change > 0, "Increased", "Decreased")
    )
```
```{r}
#| echo: TRUE
state_prices_registrations |>
  arrange(desc(price_change)) |>
  select(state, price_2021, price_2023, price_change, price_direction, EV_count) |>
  head(5)
```
## Visualization
```{r}
#| echo: false
#| message: false
#| warning: false
## **Part 4: Mapping Visualization**


state_prices_map <- state_prices_registrations |>
  mutate(region = tolower(state.name[match(state, state.abb)]))
us_states <- map_data("state")
map_data_joined <- us_states |>
  left_join(state_prices_map, by = "region")
ggplot() +
  geom_polygon(
    data = map_data_joined,
    aes(long, lat, group = group, fill = price_change),
    color = "white") +
  geom_point(
    data = map_data_joined |>
      group_by(region) |>
      summarize(
        long = mean(range(long)), 
        lat = mean(range(lat)),
        EV_count = mean(EV_count, na.rm = TRUE)),
    aes(long, lat, size = EV_count),
    color = "black", alpha = 0.6) +
  scale_fill_gradient2(
    low = "blue", mid = "white", high = "red", midpoint = 0,
    name = "Energy Price Change") +
  scale_size_continuous(
    range = c(1, 10),
    name = "EV Registrations") +
  coord_fixed(1.3) +
  theme_minimal() +
  labs(
    title = "EV Registrations vs Change in Energy Price (2021â€“2023)",
    subtitle = "Circle size shows EV registration count; color shows price change") +
  theme(
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank()
  )
```

## Analysis
The map visualization and the expanded summary table reveal several clear patterns. States with smaller increases or decreases in average energy prices, such as California, Arizona, and Colorado, tend to have the highest EV registration counts. Conversely, states with larger price increases often have fewer EVs. This suggests that lower or more stable energy costs may encourage EV adoption.

Additionally, by comparing the price change and EV registration columns in the table, we see that states experiencing moderate price increases can still have substantial EV registrations if they are traditionally high-adoption states (e.g., California). This indicates that while energy price is likely an influential factor, other regional or policy factors may also contribute to EV adoption.

Overall, the combination of the map and the data table helps answer the research question by showing that there is a general trend linking lower energy prices to higher EV registrations, though the relationship is not strictly linear. Further analysis, such as a scatter plot or correlation analysis, could quantify this relationship more precisely.